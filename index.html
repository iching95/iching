<!DOCTYPE html>
<html>
<head>
  <title>iChing</title>
  <script>

    const deviceCookMatch = window.location.search.match(/device=([^&]+)/);
    const themeCookMatch  = window.location.search.match(/theme=([^&]+)+/);

    let isWatch = false;
    let theme = "dark";
    let device = "phone";
    let last = 0;

    const cookMatch = document.cookie?document.cookie.match(/prefs=(.+)/):false;
    
    if(cookMatch){
      let cookie = JSON.parse(cookMatch[1]);
      device = cookie.device;
      theme = cookie.theme;
      last = cookie.last;
      isWatch = (cookie.device == "watch");
    }

    device = deviceCookMatch?deviceCookMatch[1]:device;
    theme =  themeCookMatch?themeCookMatch[1]:theme;

    var expires = (new Date(Date.now() + 86400 * 1000)).toUTCString();

    document.cookie = "prefs=" +JSON.stringify({
        device:device,
        theme :theme,
        last:last
    }) + "; expires=" + expires + ";path=/;";

    isWatch = (device == "watch");

  </script>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <link rel="stylesheet" href="style.css?v9">
</head>

<body>
  <div id="last-go-btn"></div>
  <div id="rand-2" class="rand"></div>
  <div id="tb1-container"></div>
  <div id="rand-3" class="rand"></div>
  <div id="tb2-container"></div>
  <div id="rand-1" class="rand"></div>
  <div id="tb3-container"></div>

  <script>

    document.body.classList.add(`theme-${theme}`);

    var randLines = function(){
      var line1 = "<span>" + String.fromCharCode(9776 + Math.floor(Math.random() * 8)) + "</span>"
      var line2 = "<span>" + String.fromCharCode(9776 + Math.floor(Math.random() * 8)) + "</span>"
      var dice =  "<span>" + String.fromCharCode(9856 + Math.floor(Math.random() * 6)) + "</span>"
      return line1 + line2 + dice ;
    }

    fetch(`https://instant-cell-9492.iching.workers.dev/`)
      .then((response) => response.json())
      .then(json => {
        console.log(json);
        if(json.idx){
          const last = json.idx;
          document.getElementById("last-go-btn").innerHTML = `
          <button onclick="location.href='reader.html?i=${last}'" type="button">last read (${last})</button>
          `;
        }
    });


    let rows = null;

    fetch('data.txt')
      .then(response => response.text())
      .then((data) => {
        rows = JSON.parse(data);
        let n = 1;
        let tbodyHTML1 = "";
        const skip = [9,20,30,30,30,33,33,35,51,60,61,63];
        
        for (let i=1;i<=13;i++){
          tbodyHTML1 += ("<tr>");
          for (let j=1;j<=7;j++){
            // console.log(n);
            if(rows[n]){
              tbodyHTML1 += (`<td><a href='reader.html?i=${n}'><span>${n}</span> ${rows[n].c}</a></td>`);
              for (let k=0; k<((rows[n].c.length - 1) + skip.filter(x => x === n).length); k++, j++){
                tbodyHTML1 += ("<td><span></span></td>");
              }
              n++;
            }
          }
          tbodyHTML1 += ("</tr>");
        }

        const order = "天澤火雷風水山地";

        let tbodyHTML2 = "";

        for (let i=0;i<8;i++){

          tbodyHTML2 += ("<tr>");
          const row = Object.entries(rows).filter(row => (row[1].d === order[i] || row[1].d[1] === order[i]));
          
          for (let j=0;j<8;j++){
            const cell = row.filter(cell => (cell[1].d === order[j] || cell[1].d[0] === order[j]));
            
            const n = cell[0][0];
            const content = cell[0][1];
            const html = `<td>
                <span onclick="findPair(${parseInt(n)})" class='symbol' id='symbol-tb2-${parseInt(n)}'>
                  ${String.fromCharCode(19904+parseInt(n)-1)}
                </span>
              ` + (content.d.length==2?`
                <div>${content.d}</div><a class="tb2-l" href='reader.html?i=${n}' ><c>${content.c}</c></a>
              `:`
                <span class="tb-char-double"><a class="tb2-l" href='reader.html?i=${n}'><c>${content.c}</c></a></span><div>為${content.d}</div>`) + '</td>'
             tbodyHTML2 += html;
          }

          tbodyHTML2 += ("</tr>");
        }

        if(last){
          /*
          console.log(last)
          document.getElementById("last-go-btn").innerHTML = `
          <button onclick="location.href='reader.html?i=${last}'" type="button">last read (${last})</button>
          `;
          */
        }

        const months = [24,19,11,34,43,1,44,33,12,20,23,2];
        let tbodyHTML3 = "";

        for (let i=0;i<2;i++){
          tbodyHTML3 += ("<tr>");
          for (let j=0;j<6;j++){
            // console.log(n);
            const k = i*6 + j;
            const n = months[k];
            const content = rows[n];
            const mth = (11+k-1)%12;
            const mthString = new Date(0,mth+1,0).toLocaleString('en-US', { month: 'short', });
            console.log(mth);
            const html = `<td><span class='${((mth)==new Date().getMonth())?'mth-current':'mth'}'>${mthString}</span><span class='symbol'>${String.fromCharCode(19904+parseInt(n)-1)}</span>` + (content.d.length==2?`
                <div>${content.d}</div><a class="tb2-l" href='reader.html?i=${n}' ><c>${content.c}</c></a>
              `:`
                <span class="tb-char-double"><a class="tb2-l" href='reader.html?i=${n}'><c>${content.c}</c></a></span><div>為${content.d}</div>`) + '</td>'
            tbodyHTML3 += html;
          }
          tbodyHTML3 += ("</tr>");
        }

        const tableHTML1 = "<table class='tb1' style='width:100%;'><tbody>" + tbodyHTML1 + "</tbody></table>";
        const tableHTML2 = "<table class='tb2' style='width:100%;'><tbody>" + tbodyHTML2 + "</tbody></table>";
        const tableHTML3 = "<table class='tb3' style='width:100%;'><tbody>" + tbodyHTML3 + "</tbody></table>";

        document.getElementById("tb1-container").innerHTML = tableHTML1;
        document.getElementById("tb2-container").innerHTML = tableHTML2;
        document.getElementById("tb3-container").innerHTML = tableHTML3;

        document.getElementById("rand-2").innerHTML = randLines();
        document.getElementById("rand-3").innerHTML = randLines();

        document.getElementById("rand-1").onclick = function(){ switchHide(); resetSymbol(); }
        document.getElementById("rand-2").onclick = function(){ switchHide(); resetSymbol(); }
        document.getElementById("rand-3").onclick = function(){ switchHide(); resetSymbol(); }

      })

      document.getElementById("rand-1").innerHTML = randLines();

      
  </script>

  <script>

    function resetSymbol(){
      Array.from(document.getElementsByClassName(`symbol-hightlight`)).map(ele=>{
        ele.className = "symbol";
      })
    }

    var stateHide = false;
    var switchHide = function(){
      
      stateHide = !stateHide;
      var anchors = document.getElementsByClassName('tb2-l');
      for(var i = 0; i < anchors.length; i++) {
        var anchor = anchors[i];
        anchor.className = stateHide?"tb2-l tb2-l-hidden":"tb2-l";
        anchor.onclick = stateHide?switchHide:null;
      }
      return false;
      
    }

    var findPair = function(n){

      resetSymbol();

      const cross = Object.entries(rows).filter(row => (row[1].d[0] === rows[n].d[1] && row[1].d[1] === rows[n].d[0]));
      const pair = (n%2>0)?(n+1):(n-1);

      console.log(n + ", " + pair);
      console.log(cross);

      if(cross.length){
        
        const crossIdx = cross[0][0];
        console.log(crossIdx);

        if(crossIdx != pair){
          document.getElementById(`symbol-tb2-${crossIdx}`).className = "symbol symbol-hightlight";
        }

      }

      document.getElementById(`symbol-tb2-${n}`).className    = "symbol symbol-hightlight";
      document.getElementById(`symbol-tb2-${pair}`).className = "symbol symbol-hightlight";
      document.getElementById("tb2-container").scrollIntoView();
    }

  </script>

</body>
</html>
