<!DOCTYPE html>
<html>
<head>
  <title>iChing</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <link rel="stylesheet" href="style.css?65">
  <link rel="icon" type="image/png" href="data:image/png;base64,iVBORw0KGgo=">
  <script>

    const deviceCookMatch = window.location.search.match(/device=([^&]+)/);
    const themeCookMatch  = window.location.search.match(/theme=([^&]+)+/);

    let isWatch = false;
    let theme = "dark";
    let device = "phone";
    let last = 0;

    const cookMatch = document.cookie?document.cookie.match(/prefs=(.+)/):false;
    
    if(cookMatch){
      let cookie = JSON.parse(cookMatch[1]);
      device = cookie.device;
      theme = cookie.theme;
      last = cookie.last;
      isWatch = (cookie.device == "watch");
    }

    device = deviceCookMatch?deviceCookMatch[1]:device;
    theme =  themeCookMatch?themeCookMatch[1]:theme;

    var expires = (new Date(Date.now() + 86400 * 1000)).toUTCString();

    document.cookie = "prefs=" +JSON.stringify({
        device:device,
        theme :theme,
        last:last
    }) + "; expires=" + expires + ";path=/;";

    isWatch = (device == "watch");
    
  </script>
</head>

<body>
  <div id="container container-index">
    <div id="rand-1" class="rand rand-top"></div>
    <div id="last-go-btn"></div>
    <div id="tb1-nav"></div>
    <div id="tb1-container"></div>
    <div id="rand-2" class="rand"></div>
    <div id="tb2-container"></div>
    <div id="rand-3" class="rand"></div>
    <div id="tb3-container"></div>
  </div>
  <script>
    
    let randImg, randLine;

    let rand = null;
    let rows = null;

    function tb1Scroll(n){
      document.getElementById(`symbol-tb1-${n}`).scrollIntoView();
    }

    const genTb1Content = (_rows) => {

      const rows = _rows;

      let n = 1;
      let tbodyHTML1 = "";
      const skip   = [0,2,3];
      
      let navHTML = '';

      for (let i=1;i<=5;i++){
        tbodyHTML1 += ("<tr>");
        for (let j=1;j<=5;j++){

          const skip=[];
          const double=[];

          const content = rows?rows[n]:{
            d:"．<br>．",
            c:double.includes(n)?"．<br>．":"．"
          };

          if(j==1){
          }

          const alefbet = String.fromCharCode(parseInt('05D0', 16)+parseInt(n)-1);
          const num = parseInt(n);

          const html = `<td>
          <span>${num}</span>
          <span class='alefbet' id='alefbet-tb1-${parseInt(n)}'>
            <span>${alefbet}</span>
          </span>
          </td>`;
          
          tbodyHTML1 += html;

          for (let k=0; k<((Math.min(content.c.length, 2) - 1) + skip.filter(x => x === n).length); k++, j++){
              tbodyHTML1 += ("<td><span></span></td>");
          }

          n++;

        }

        tbodyHTML1 += ("</tr>");

        if(!rows && n > 30){
          break;
        }

      }
      
      return {
        table:tbodyHTML1,
        nav:navHTML
      };

    }

    document.getElementById("tb1-container").innerHTML = "<table class='tb1' style='width:100%;'><tbody>" + genTb1Content().table + "</tbody></table>";

    const data = localStorage.getItem("hebrew-v1");
    rows = data?JSON.parse(data):null;

    const layoutData = (_data) => {

      const rows = _data;
      const tb1 = genTb1Content(rows);

      let tbodyHTML1 = tb1.table;

      const tableHTML1 = "<table class='tb1' style='width:100%;'><tbody>" + tbodyHTML1 + "</tbody></table>";

      document.getElementById("tb1-container").innerHTML = tableHTML1;
    }

    const pData = data?layoutData(rows):fetch('hebrew-data.txt')
      .then(response => response.text())
      .then((data) => {
        // rows = JSON.parse(data);
        const tdata = data.split(/[-]/g);
        
        rows = [];
        tdata.map((r,i)=>{
          tdata[i] = tdata[i].trim().split(/\r?\n|\r|\n/g);
        })
        console.log(tdata);

        tdata[0].map((r,i)=>{
          rows[i] = {
            a:tdata[0][i],
            p:tdata[1][i],
            s:tdata[2][i][0],
            l:tdata[2][i].length,
          }
        })
        
        console.log(rows);
        localStorage.setItem("hebrew-v1", JSON.stringify(rows));

        layoutData(rows);
      })


  </script>

</body>
</html>