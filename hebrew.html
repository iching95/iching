<!DOCTYPE html>
<html>
<head>
  <title>iChing</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <link rel="stylesheet" href="style.css?65">
  <link rel="icon" type="image/png" href="data:image/png;base64,iVBORw0KGgo=">
  <script>

    const deviceCookMatch = window.location.search.match(/device=([^&]+)/);
    const themeCookMatch  = window.location.search.match(/theme=([^&]+)+/);

    let isWatch = false;
    let theme = "dark";
    let device = "phone";
    let last = 0;

    const cookMatch = document.cookie?document.cookie.match(/prefs=(.+)/):false;
    
    if(cookMatch){
      let cookie = JSON.parse(cookMatch[1]);
      device = cookie.device;
      theme = cookie.theme;
      last = cookie.last;
      isWatch = (cookie.device == "watch");
    }

    device = deviceCookMatch?deviceCookMatch[1]:device;
    theme =  themeCookMatch?themeCookMatch[1]:theme;

    var expires = (new Date(Date.now() + 86400 * 1000)).toUTCString();

    document.cookie = "prefs=" +JSON.stringify({
        device:device,
        theme :theme,
        last:last
    }) + "; expires=" + expires + ";path=/;";

    isWatch = (device == "watch");
    
  </script>
</head>

<body>
  <div id="container container-index">
    <div id="rand-1" class="rand rand-top"></div>
    <div id="block"></div>
    <div id="last-go-btn"></div>
    <!-- <div id="regen-rand-btn"></div> -->
    <div id="tb1-nav"></div>
    <div id="tb1-container"></div>
    <div id="rand-2" class="rand"></div>
    <div id="tb2-container"></div>
    <div id="rand-3" class="rand"></div>
    <div id="tb3-container"></div>
  </div>
  <script>
    
    fetch(`https://instant-cell-9492.iching.workers.dev/`)
    .then((response) => response.json())
    .then(json => {
      if(json.idx){

        const last = json.idx;
        const dest = json.book?`reader.html?i=${last}&t=book${json.line?("#line"+json.line):""}`:`reader.html?i=${last}`;
        const stateMod = json.line?"history.pushState({},'','"+`reader.html?i=${last}`+"');":"var i=0;";

        document.getElementById("last-go-btn").innerHTML = `
        <a onclick="${stateMod};location.href='${dest}';" >
          last read (${last}${json.line?("-"+json.line):""})
        </a>
        `;
      }
    });

    const rpc = "https://cloudflare-eth.com";
    const rpcObj = {"jsonrpc":"2.0","method":"eth_getBlockByNumber","params":["latest", false],"id":1};

    const order = "天澤火雷風水山地";

    let randImg, randLine;

    let rand = null;
    let rows = null;

    var randLines = function(_img, _line = null, loadImg = false){

      let img = null;
      let top = null;
      let low = null;

      if(rows && rows[_img] && loadImg){
        img = rows[_img];
        top = order.indexOf(img.d[0]);
        low = img.d[1]?order.indexOf(img.d[1]):top;
      }

      var line1 = "<span>" + (img?String.fromCharCode(9776 + top):"⚊") + "</span>";
      var line2 = "<span>" + (img?String.fromCharCode(9776 + low):"⚋") + "</span>";
      var dice =  "<span>" + ((_line!==null)?String.fromCharCode(9856 + parseInt(_line)):"⚇") + "</span>";

      return line1 + line2 + dice;

    }

    document.getElementById("rand-1").innerHTML = randLines();
    document.body.classList.add(`theme-${theme}`);
    document.getElementById("last-go-btn").innerHTML = `
    <a>last read (...)</a>
    `;

    document.getElementById("block").innerHTML = `<span>0x000000000000</span>
      <span>10000000</span>
      <span>・00:00:00</span>
      <span id="block-loader"></span>`;
    document.getElementById("block").classList.add(isWatch?"block-watch":"block");

    let blockLastMod = 0;

    function tb1Scroll(n){
      document.getElementById(`symbol-tb1-${n}`).scrollIntoView();
    }

    const genTb1Content = (_rows) => {

      const rows = _rows;

      let n = 1;
      let tbodyHTML1 = "";
      const skip   = [9,20,30,30,30,33,33,35,51,60,61,63];
      const double = [9,13,14,21,25,26,28];
      
      let navHTML = '';

      for (let i=1;i<=13;i++){
        tbodyHTML1 += ("<tr>");
        for (let j=1;j<=7;j++){

          const content = rows?rows[n]:{
            d:"．<br>．",
            c:double.includes(n)?"．<br>．":"．"
          };

          if(j==1){
          }

          const alefbet = String.fromCharCode(parseInt('05D0', 16)+parseInt(n)-1);
          const num = parseInt(n);

          const html = `<td>
          <span>${num}</span>
          <span class='symbol' id='symbol-tb1-${parseInt(n)}'>
            <span>${alefbet}</span>
          </span>
          </td>`;
          
          tbodyHTML1 += html;

          for (let k=0; k<((Math.min(content.c.length, 2) - 1) + skip.filter(x => x === n).length); k++, j++){
              tbodyHTML1 += ("<td><span></span></td>");
          }

          n++;

        }

        tbodyHTML1 += ("</tr>");

        if(!rows && n > 30){
          break;
        }

      }
      
      return {
        table:tbodyHTML1,
        nav:navHTML
      };

    }

    document.getElementById("tb1-container").innerHTML = "<table class='tb1' style='width:100%;'><tbody>" + genTb1Content().table + "</tbody></table>";

    const layoutData = (_data) => {

      const rows = _data;
      const tb1 = genTb1Content(rows);

      let tbodyHTML1 = tb1.table;

      const tableHTML1 = "<table class='tb1' style='width:100%;'><tbody>" + tbodyHTML1 + "</tbody></table>";

      document.getElementById("tb1-container").innerHTML = tableHTML1;
    }

    layoutData();


  </script>

</body>
</html>