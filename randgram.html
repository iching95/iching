<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Side A & B Generator</title>
    <style>

        .matrix {
            position: relative;
            margin:20px;
            min-width: 10px;
            min-height: 20px;        
        }

        .matrix:before, .matrix:after {
            content: "";
            position: absolute;
            top: 0;
            border: 1px solid #000;
            width: 6px;
            height: 100%;
        }
        .matrix:before {
            left: -6px;
            border-right: 0px;
        }
        .matrix:after {
            right: -6px;
            border-left: 0px;
        }
        .matrix td {
            padding: 5px;    
            text-align: center;
        }

        table {
            border-collapse: collapse;
            max-width: 400px;
        }
        table, th, td {
            text-align: center;
        }

        th, td {
            width: 50%;
        }

        button {
            margin: 5px;
            min-height: 30px;
        }

        body {
            text-align: left;
        }
    </style>
</head>

<body>

<button onclick="generateTable()">Generate Initial Side A & B</button>
<button onclick="applyRule3()">Apply Rule 3</button>
<button onclick="applyRule4a()">Apply Rule 4a</button>
<button onclick="applyRule4b()">Apply Rule 4b</button>
<button onclick="convertSides()">Convert Sides A & B (4>2, 1>3)</button>
<button onclick="getHexagramNames()">Get Names</button>

<table class="matrix">
    <tbody id="tableBody">
    </tbody>
</table>
<table>
    <tr>
        <td id="hexagramNameA"></td>
        <td id="hexagramNameB"></td>
    </tr>
</table>

<script>

    const BASE_URL = "https://ctext.org/book-of-changes/";

    const hexagrams = {
        "000000": { n: 02, p: "kun", s: "䷁" },
        "100001": { n: 27, p: "yi", s: "䷚" },
        "010001": { n: 03, p: "zhun", s: "䷂" },
        "110001": { n: 42, p: "yi", s: "䷩" },
        "001001": { n: 51, p: "zhen", s: "䷲" },
        "101001": { n: 21, p: "shi-ke", s: "䷔" },
        "011001": { n: 17, p: "sui", s: "䷐" },
        "111001": { n: 25, p: "wu-wang", s: "䷘" },
        "000101": { n: 36, p: "ming-yi", s: "䷣" },
        "100101": { n: 22, p: "bi", s: "䷕" },
        "010101": { n: 63, p: "ji-ji", s: "䷾" },
        "110101": { n: 37, p: "jia-ren", s: "䷤" },
        "001101": { n: 55, p: "feng", s: "䷶" },
        "101101": { n: 30, p: "li", s: "䷝" },
        "011101": { n: 49, p: "ge", s: "䷰" },
        "111101": { n: 13, p: "tong-ren", s: "䷌" },
        "000011": { n: 19, p: "lin", s: "䷒" },
        "100011": { n: 41, p: "sun", s: "䷨" },
        "010011": { n: 60, p: "jie", s: "䷻" },
        "110011": { n: 61, p: "zhong-fu", s: "䷼" },
        "001011": { n: 54, p: "gui-mei", s: "䷵" },
        "101011": { n: 38, p: "kui", s: "䷥" },
        "011011": { n: 58, p: "joyful", s: "䷹" },
        "111011": { n: 10, p: "lu", s: "䷉" },
        "000111": { n: 11, p: "tai", s: "䷊" },
        "100111": { n: 26, p: "da-chu", s: "䷙" },
        "010111": { n: 05, p: "xu", s: "䷄" },
        "110111": { n: 09, p: "xiao-chu", s: "䷈" },
        "001111": { n: 34, p: "da-zhuang", s: "䷡" },
        "101111": { n: 14, p: "da-you", s: "䷍" },
        "011111": { n: 43, p: "guai", s: "䷪" },
        "111111": { n: 01, p: "qian", s: "䷀" },
        "111110": { n: 44, p: "gou", s: "䷫" },
        "011110": { n: 28, p: "da-guo", s: "䷛" },
        "101110": { n: 50, p: "ding", s: "䷱" },
        "001110": { n: 32, p: "heng", s: "䷟" },
        "110110": { n: 57, p: "xun", s: "䷸" },
        "010110": { n: 48, p: "jing", s: "䷯" },
        "100110": { n: 18, p: "gu", s: "䷑" },
        "000110": { n: 46, p: "sheng", s: "䷭" },
        "111010": { n: 06, p: "song", s: "䷅" },
        "011010": { n: 47, p: "kun", s: "䷮" },
        "101010": { n: 64, p: "wei-ji", s: "䷿" },
        "001010": { n: 40, p: "xie", s: "䷧" },
        "110010": { n: 59, p: "huan", s: "䷺" },
        "010010": { n: 29, p: "kan", s: "䷜" },
        "100010": { n: 04, p: "meng", s: "䷃" },
        "000010": { n: 07, p: "shi", s: "䷆" },
        "111100": { n: 33, p: "dun", s: "䷠" },
        "011100": { n: 31, p: "xian", s: "䷞" },
        "101100": { n: 56, p: "lv", s: "䷷" },
        "001100": { n: 62, p: "xiao-guo", s: "䷽" },
        "110100": { n: 53, p: "jian", s: "䷴" },
        "010100": { n: 39, p: "gu", s: "䷦" },
        "100100": { n: 52, p: "gen", s: "䷳" },
        "000100": { n: 15, p: "qian", s: "䷎" },
        "111000": { n: 12, p: "pi", s: "䷋" },
        "011000": { n: 45, p: "cui", s: "䷬" },
        "101000": { n: 35, p: "jin", s: "䷢" },
        "001000": { n: 16, p: "yu", s: "䷏" },
        "110000": { n: 20, p: "guan", s: "䷓" },
        "010000": { n: 08, p: "bi", s: "䷇" },
        "100000": { n: 23, p: "bo", s: "䷖" }
    };
    let sideA = [];
    let sideB = [];
    let backupSideA = [];
    let backupSideB = [];

    const urlParams = new URLSearchParams(window.location.search);
    const showCircles = urlParams.get('c') === '1';

    function generateRandomNumber() {
        return Math.floor(Math.random() * 4) + 1;
    }

    function numberToCircles(num) {
        if (!showCircles) return num;

        const circle = "⭗";
        return circle.repeat(num);
    }

    function generateTable() {
        sideA = Array.from({ length: 6 }, generateRandomNumber);
        sideB = Array.from({ length: 6 }, generateRandomNumber);
        backupSideA = [...sideA];
        backupSideB = [...sideB];
        document.getElementById("hexagramNameA").innerText = "";
        document.getElementById("hexagramNameB").innerText = "";
        updateTable();
    }

    function applyRule3() {
        for (let i = 0; i < 6; i++) {
            if (sideA[i] === 2 || sideA[i] === 3) {
                sideB[i] = sideA[i];
            }
        }
        updateTable();
    }

    function applyRule4a() {
        for (let i = 0; i < 6; i++) {
            if (sideA[i] === 1 && (sideB[i] === 2 || sideB[i] === 4)) {
                sideB[i] = 2;
            }
        }
        updateTable();
    }

    function applyRule4b() {
        for (let i = 0; i < 6; i++) {
            if (sideA[i] === 4 && (sideB[i] === 1 || sideB[i] === 3)) {
                sideB[i] = 3;
            }
        }
        updateTable();
    }

    function convertSides() {
        for (let i = 0; i < 6; i++) {
            if (sideA[i] === 4) sideA[i] = 2;
            if (sideA[i] === 1) sideA[i] = 3;
            if (sideB[i] === 4) sideB[i] = 2;
            if (sideB[i] === 1) sideB[i] = 3;
        }
        updateTable();
    }

    function getHexagramNames() {

      let binaryA = sideA.map(x => (x === 2 || x === 4) ? '0' : '1').join('');
      let binaryB = sideB.map(x => (x === 2 || x === 4) ? '0' : '1').join('');

        console.log(binaryA);
        console.log(binaryB);

        document.getElementById("hexagramNameA").innerHTML = `<a href="${hexagrams[binaryA].url}" target="_blank">${hexagrams[binaryA].p}</a>`;
        document.getElementById("hexagramNameB").innerHTML = `<a href="${hexagrams[binaryB].url}" target="_blank">${hexagrams[binaryB].p}</a>`;

    }

    function updateTable() {

        let tableRows = "";

        for (let i = 0; i < 6; i++) {
            let sideAColor = (sideA[i] !== backupSideA[i]) ? 'red' : 'black';
            let sideBColor = (sideB[i] !== backupSideB[i]) ? 'red' : 'black';

            tableRows += `<tr>
                <td style="color:${sideAColor}">${numberToCircles(sideA[i])}</td>
                <td style="color:${sideBColor}">${numberToCircles(sideB[i])}</td>
            </tr>`;
        }

        backupSideA = [...sideA];
        backupSideB = [...sideB];

        document.getElementById("tableBody").innerHTML = tableRows;
    }

</script>

</body>

</html>
